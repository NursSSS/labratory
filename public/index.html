<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  </head>

  <style>
    .notvisible {
      display: none !important;
    }

    .visible {
      display: flex !important;
    }
  </style>

  <body>
    <div style="position: relative" id="main">
      <div>
        <table border="1">
          <thead>
            <tr>
              <th width="200">Имя</th>
            </tr>
          </thead>

          <tbody id="tablebody"></tbody>
        </table>

        <div
          id="historyTransaction"
          class="notvisible"
          style="
            position: absolute;
            left: 208px;
            top: 0;
            display: flex;
            flex-direction: column;
          "
        >
          <table border="1">
            <thead>
              <tr>
                <th width="200">Дебит</th>
                <th width="200">Кредит</th>
                <th width="200">Коментарий</th>
                <th width="200">Дата</th>
                <th width="200">Статус</th>
              </tr>
            </thead>

            <tbody id="tablebodyinfo"></tbody>
          </table>
        </div>
      </div>
    </div>

    <div id="create-transaction" class="notvisible">
      <h2>Создать запись</h2>
      <form action="#" method="post" id="form-transaction">
        <input type="number" name="debit" placeholder="Debit" />
        <input type="number" name="credit" placeholder="Credit" />
        <input type="text" name="comment" placeholder="Comment" />
        <input type="number" name="status" placeholder="Status" required />
        <button type="submit" id="transaction-button">Отправить</button>
      </form>
    </div>
  </body>

  <script>
    const apiUrl = "http://localhost:3000/api/doctors";

    fetch(apiUrl)
      .then((response) => {
        if (!response.ok) {
          alert("Error fetching doctors: " + response.status);
          return;
        }
        return response.json();
      })
      .then((responseData) => {
        buildHTMLDoctors(responseData);
      })
      .catch((error) => {
        console.error("Error fetching doctors:", error);
      });

    function buildHTMLDoctors(data) {
      let html = ``;

      for (let doctor of data) {
        html += `<tr>
          <td class="nameBtn" doctorid="${doctor.id}" style="cursor: pointer;"
          onclick="transaction(${doctor.id})">${doctor.name}</td>
        </tr>`;
      }

      $("#tablebody").append(html);
    }

    function transaction(doctorId) {
      const historyTransaction = document.getElementById("historyTransaction");
      const tableButtons = document.getElementById("table-buttons");
      document.getElementById("tablebodyinfo").innerHTML = "";

      if (tableButtons) {
        historyTransaction.removeChild(tableButtons);
      }

      const apiUrl = `http://localhost:3000/api/transactions/${doctorId}`;

      fetch(apiUrl)
        .then((response) => {
          if (!response.ok) {
            alert("Error fetching transactions: " + response.status);
            return;
          }
          return response.json();
        })
        .then((responseData) => {
          buildHTMLTransactions(responseData, doctorId);
        })
        .catch((error) => {
          console.error("Error fetching transactions:", error);
        });

      $("#historyTransaction").removeClass("notvisible");
      $("#historyTransaction").addClass("visible");
      $("#historyTransaction").addClass(`docId${doctorId}`);
    }

    function buildHTMLTransactions(data, doctor_id) {
      let html = ``;
      let debit = 0;
      let credit = 0;

      for (let item of data) {
        debit += item.debit;
        credit += item.credit;

        html += `<tr>
          <td>${item.debit}</td>
          <td>${item.credit}</td>
          <td>${item.comment}</td>
          <td>${item.date}</td>
          <td>${item.status}</td>
          <td><input type="checkbox" class="transaction-checkbox" data-transaction-id="${item.id}"></td>
        </tr>`;
      }

      html += `<tr>
          <td colspan=6 align="right" >Итого: ${debit - credit}</td>
        </tr>`;

      const buttons = `
        <div id="table-buttons" style="display: flex; justify-content: space-between;">
        <button style="margin: 10px 0;" onclick="openTransactionForm(${doctor_id})">
          Добавить запись
        </button>
        <button style="margin: 10px 0;" id="close-cash-button" onclick="selectedIds()">
          Закрыть кассу
        </button>
        </div>
      `;

      $("#tablebodyinfo").append(html);
      $("#historyTransaction").append(buttons);
    }

    function openTransactionForm(doctorId) {
      $("#main").removeClass("visible").addClass("notvisible");
      $("#create-transaction").removeClass("notvisible").addClass("visible");

      $("#transaction-button").click(function (e) {
        e.preventDefault();
        createTransaction(doctorId);
      });
    }

    function createTransaction(doctorId) {
      const form = document.getElementById("form-transaction");
      const formData = new FormData(form);
      const formDataObject = {};

      formData.forEach((value, key) => {
        formDataObject[key] = value;
      });

      const apiUrl = `http://localhost:3000/api/transactions/${doctorId}`;

      fetch(apiUrl, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify(formDataObject),
      })
        .then((response) => {
          if (!response.ok) {
            alert(response.status);
            return;
          }

          window.location.href = "http://localhost:3000/index";
        })
        .catch((error) => {
          console.error(error);
        });
    }

    function selectedIds() {
      const selectedIds = [];

      $(".transaction-checkbox:checked").each(function () {
        const transactionId = $(this).data("transaction-id");
        selectedIds.push(transactionId);
      });

      if (!selectedIds.length) {
        alert("Список пуст");
        return;
      }

      const data = {
        transaction_ids: selectedIds,
      };

      const apiUrl = `http://localhost:3000/api/transactions`;

      fetch(apiUrl, {
        method: "PUT",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify(data),
      }).then((response) => {
          if (!response.ok) {
            alert(response.status);
            return;
          }

          window.location.reload();
        })
        .catch((error) => {
          console.error("Error during fetch:", error);
        });
    }
  </script>
</html>
